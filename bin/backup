#!/bin/bash

usage() { echo "Usage: $(basename $0) -o <backup dir> -s <sources file> -e <exclude file>" 1>&2; exit 1; }

# Get arguments
while getopts ":h:o:s:e:" opt; do
  case "$opt" in
    h)
      usage
      ;;
    o)
      backup_path="$OPTARG"
      ;;
    s)
      sources_path="$OPTARG"
      ;;
    e)
      exclude_path="$OPTARG"
      ;;
  esac
done

# If missing any arguments, show usage
if [ -z "$backup_path" ] || [ -z "$sources_path" ] || [ -z "$exclude_path" ]
then
  usage
fi

# Read the config file to find and back up each path
cat $sources_path | while read in_path; do
  # Cut off any trailing slashes
  # Ex: /Users/Ryan/_Home/ -> /Users/Ryan/_Home
  in_path_trimmed="${in_path%"${in_path##*[!/]}"}"
  # Get the directory name and re-add a single trailing slash
  # Ex: /Users/Ryan/_Home -> _Home -> _Home/
  dir_name="${in_path_trimmed##*/}/"

  # And now we have a path to the output!
  # Ex: /path/to/backup + _Home/ -> /path/to/backup/_Home/
  out_path="$backup_path/$dir_name"
  echo $out_path

  # And now we can back up the directory
  rsync -av --delete --exclude-from="$exclude_path" "$in_path" "$out_path"
  # (Quotes are necessary in case of special characters)
done
